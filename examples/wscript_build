#!/usr/bin/env python

''' This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public Licence as published by
the Free Software Foundation, either version 3 of the Licence, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
file COPYING for more details. '''

import os, re

buildme = not bld.env.TOOLS_DISABLED and not bld.env.EXAMPLES_DISABLED
builduis = bld.env.BUILD_EXAMPLE_UIS

if buildme:
	examples = [ "silence", "workhorse", "beep" ]
	first_plugin = True

	install_dir = os.path.join (bld.env.LV2DIR, 'lvtk.lv2')
	module_pat = re.sub('^lib', '', bld.env.cxxshlib_PATTERN)
	module_ext = module_pat[module_pat.rfind('.'):]
	plugin_env = bld.env.derive()
	plugin_env.cxxshlib_PATTERN = module_pat

	for slug in examples:
		if first_plugin:
			first_plugin = False
			bld (
				features	= 'subst',
				source		= 'manifest.ttl.in',
				target		= 'lvtk.lv2/manifest.ttl',
				LIB_EXT		= module_ext,
				install_path = install_dir
			)

		bld (
			features	= 'subst',
			source		= '%s.ttl' % slug,
			target		= 'lvtk.lv2/%s.ttl' % slug,
			install_path = install_dir
		)

		if 'silence' == slug or 'workhorse' == slug:
			plugin = bld.shlib (
				cxxflags      = '-std=c++14',
				name          = slug,
				target        = 'lvtk.lv2/%s' % slug,
				source        = "%s.cpp" % slug,
				includes      = [],
				use           = bld.env.LIB_LVTK_PLUGIN,
				install_path  = install_dir,
				env			  = plugin_env
			)

		# Build the plugin gui (if able)
		uislug = slug + "_ui"
		uisrc  = uislug + ".cpp"

		if builduis and bld.path.find_resource(uisrc):
			ui = bld.shlib(
				lv2_bundle	  =	True,
				lv2_target    = "lvtk.lv2",
				name          = uislug,
				target        = uislug,
				source        = uisrc,
				cxxflags       = ['-Wl,-z,nodelete'],
				includes      = ["../build/examples"],
				use           = [bld.env.LIB_LVTK_UI, "gtkmm"],
				LIB_EXT		  = bld.env.pluginlib_EXT
			)
